<html>
<head>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script>
  
  // ISO8601 Date extension
  Date.ISO8601PartMap = {
    Year : 1,
    Month : 2,
    Date : 3,
    Hours : 4,
    Minutes : 5,
    Seconds : 6,
    Milliseconds: 7
  }

  Date.matchISO8601 = function(text) { 
    return text.match(/^(\d{4})(?:-?(\d{2})(?:-?(\d{2})(?:T(\d{2}):?(\d{2})(?::?(\d{2})(?:[.]?(\d+))?)?(?:Z|(?:([+-])(\d{2}):?(\d{2}))?)?)?)?)?$/);
  }

  Date.parseISO8601 = function(text) {
    var dateParts = this.matchISO8601(text);
    if (dateParts) {
      var date = new Date, parts, offset = 0;
      for (var prop in this.ISO8601PartMap) {
        if (part = dateParts[this.ISO8601PartMap[prop]]) 
          date['set' + prop]((prop == 'Month') ? parseInt(part)-1 : parseInt(part));
          else date['set' + prop]((prop == 'Date') ? 1 : 0);
      }

      if (dateParts[11]) {
        offset = (parseInt(dateParts[14]) * 60) + parseInt(dateParts[15]);
        offset *= ((parseInt[13] == '-') ? 1 : -1);
      }

      offset -= date.getTimezoneOffset();
      date.setTime(date.getTime() + (offset * 60 * 1000)); 

      return date;
    }
  }
  
    chrome.tabs.getSelected(null, function(tab) {
      // get the microformats from the current tab
      var hcards = chrome.extension.getBackgroundPage().hcards[tab.id];
      var hcalendars = chrome.extension.getBackgroundPage().hcalendars[tab.id];
      var hreviews = chrome.extension.getBackgroundPage().hreviews[tab.id];
      
      // let's put these suckers on the page!
      $.each(hcards, function(i, hcard) {
        // What other data should we display?
        var html = $('<li class="hcard" id="hcard-'+i+'"><div class="download"><a href="#" title="Download this hCard"><img src="images/hcard_download.png"></a></div><div class="details"><h1>' + hcard.fn + '</h1><ul></ul></div></li>');
        
        // fn is required so only output
        // the vcard if it's "valid"
        if (hcard.fn) {
          $("#hcards").append(html);
          
          if (hcard.email)
            $('#hcard-'+i+' ul').append('<li>'+ hcard.email +'</li>');
            
          if (hcard.url)
            $('#hcard-'+i+' ul').append('<li><a href="'+ hcard.url[0] +'" target="_blank">'+ hcard.url[0]+ '</a></li>');
        }
      });
      
      $.each(hcalendars, function(j, hcalendar) {
        var hcalHtml = $('<li class="hcalendar" id="hcal-'+j+'"><div class="download"><a href="#" title="Download this hCalendar"><img src="images/icon-hcalendar-download.png"></a></div><div class="details"><h1>' + hcalendar.summary + '</h1><ul><li><strong>Start:</strong> '+ Date.parseISO8601(hcalendar.dtstart).toLocaleString() +'</li></ul></div></li>');
        
        $("#hcalendars").append(hcalHtml);
                
        if (hcalendar.dtend)
          $('#hcal-'+j+' ul').append('<li><strong>End:</strong> '+ Date.parseISO8601(hcalendar.dtend).toLocaleString() +'</li>');
        
      });
      
      $.each(hreviews, function(k, hreview) {
        $("#hreviews").append('<li class="hreview" id="hreview-'+k+'"><div class="download"><img src="images/icon-hreview.png"></div><div class="details"><h1>' + hreview.item.fn + '</h1><p>' + hreview.summary + '</p></div></li>');
      });
    });
  </script>
  
  <style>
    body { margin: 0; padding: 0; min-width: 440px; font-family: Helvetica, sans-serif; color: #2a2a2a; overflow-x:hidden; }
    #microformats { margin-top: 15px;}
    #header {overflow: hidden;}
    #icon {display: block; float: left;}
    #header h1 {margin-left: 51px; height: 48px; margin-top: 12px; color: #5F7B1F;}
    ul { list-style-type: none; padding: 0;}
    h1 { font-size: 18px; font-weight: bold; line-height: 23px; margin-top: -4px;}
    a { color: #9DBD53;}
    a:hover { color: #5F7B1F;}
    .hcard, .hcalendar, .hreview { overflow: hidden; border-bottom: 1px solid #c2c2c2; margin-top:10px;}
    .download { float: left; margin-left: 5px;}
    .details { margin-left: 44px; padding-right: 20px;}
    .details ul li, p { font-size: 12px; color: #3e3e3e; margin-bottom: 10px;}
  </style>
</head>
<body>
  <div id="microformats">
    <div id="header">
      <img src="images/microformats-logo-48.png" id="icon">
      <h1>The following microformats were found:</h1>
    </div>
    <ul id="hcards">

    </ul>
    <ul id="hcalendars">

    </ul>
    <ul id="hreviews">
    
    </ul>
  </div>
</body>
</html>
