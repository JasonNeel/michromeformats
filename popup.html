<html>
<head>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/PerfectTime.js"></script>
  <script>
    chrome.tabs.getSelected(null, function(tab) {
      // get the microformats from the current tab
      var hcards = chrome.extension.getBackgroundPage().hcards[tab.id];
      var hcalendars = chrome.extension.getBackgroundPage().hcalendars[tab.id];
      var hreviews = chrome.extension.getBackgroundPage().hreviews[tab.id];
      
      // let's put these suckers on the page!
      $.each(hcards, function(i, hcard) {        
        // What other data should we display?
        var html = $('<li class="hcard" id="hcard-'+i+'"><div class="download"><a href="http://growing-flower-18.heroku.com/vcard?query='+ encodeURIComponent(JSON.stringify(hcard)) + '" title="Download this hCard" target="_blank"><img src="images/hcard_download.png"></a></div><div class="details"><h1>' + hcard.fn + '</h1><ul></ul></div></li>');
        
        // fn is required so only output
        // the vcard if it's "valid"
        if (hcard.fn) {
          $("#hcards").append(html);
          
          if (hcard.email)
            $('#hcard-'+i+' ul').append('<li>'+ hcard.email +'</li>');
            
          if (hcard.url)
            $('#hcard-'+i+' ul').append('<li><a href="'+ hcard.url[0] +'" target="_blank">'+ hcard.url[0]+ '</a></li>');
        }
      });
      
      $.each(hcalendars, function(j, hcalendar) {        
        var hcalHtml = $('<li class="hcalendar" id="hcal-'+j+'"><div class="download"><a href="http://growing-flower-18.heroku.com/vevent?query='+ encodeURIComponent(JSON.stringify(hcalendar)) + '" title="Download this hCalendar" target="_blank"><img src="images/icon-hcalendar-download.png"></a></div><div class="details"><h1>' + hcalendar.summary + '</h1><ul><li><strong>Start:</strong> '+ $.fn.strftime($.fn.parseISO(hcalendar.dtstart), '%b %d, %Y at %i:%M%P') +'</li></ul></div></li>');
        
        $("#hcalendars").append(hcalHtml);
                
        if (hcalendar.dtend)
          $('#hcal-'+j+' ul').append('<li><strong>End:</strong> '+ $.fn.strftime($.fn.parseISO(hcalendar.dtend), '%b %d, %Y at %i:%M%P') +'</li>');
      });
      
      $.each(hreviews, function(k, hreview) {      
        var hreviewHTML = $('<li class="hreview" id="hreview-'+k+'"><div class="download"><img src="images/icon-hreview.png"></div><div class="details"><h1>' + (hreview.item.fn || hreview.item.url || hreview.item.photo_url) + '</h1><ul></ul></div></li>');
                
        $("#hreviews").append(hreviewHTML);
        
        if (hreview.summary)
          $('#hreview-'+k+' ul').append('<li>' + hreview.summary + '</li>');
          
        if (hreview.description)
          $('#hreview-'+k+' ul').append('<li>'+ hreview.description +'</li>');

        if (hreview.dtreviewed)
          $('#hreview-'+k+' ul').append('<li><strong>Reviewed: </strong>'+ hreview.dtreviewed +'</li>');

        if (hreview.rating)
          $('#hreview-'+k+' ul').append('<li><strong>Rating: </strong>'+ hreview.rating +'</li>');
      });
    });
  </script>
  
  <style>
  body {
    margin: 15px 10px;
    padding: 0;
    width: 450px;
    font-family: Helvetica, sans-serif;
    color: #3b3b3b;
  }
  #header {
    overflow: hidden;
  }
  #icon {
    display: block;
    float: left;
  }
  #header h1 {
    margin-left: 51px;
    height: 48px;
    margin-top: 16px;
    color: #4b6e0e;
    font-size: 19px;
  }
  ul {
    list-style-type: none;
    padding: 0;
  }
  h1 {
    font-size: 20px;
    font-weight: normal;
    margin: 0;
  }
  a {
    color: #9DBD53;
  }
  a:hover {
    color: #5F7B1F;
  }
  .hcard, .hcalendar, .hreview {
    margin: 20px 0;
    padding: 10px 15px 5px 15px;
    overflow: hidden;
    min-height: 75px;
    border: 1px solid #c2c2c2;
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    border-radius: 10px;
    background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#eee));
  	background: -moz-linear-gradient(top,  #fff,  #eee);
  	-webkit-box-shadow: 0 1px 2px rgba(0,0,0,.2);
  	-moz-box-shadow: 0 1px 2px rgba(0,0,0,.2);
  	box-shadow: 0 1px 2px rgba(0,0,0,.2);
  }
  .hcard:hover, .hcalendar:hover, .hreview:hover {
    color: #659421;
    background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#E9F2DA));
  	background: -moz-linear-gradient(top,  #fff,  #E9F2DA);
  }
  .download {
    float: left;
  }
  .details {
  }
  .details ul li {
    font-size: 12px;
    color: #3e3e3e;
  }
  p {
    font-size: 12px;
    color: #3e3e3e;
  }
  </style>
</head>
<body>
  <div id="microformats">
    <div id="header">
      <img src="images/microformats-logo-48.png" id="icon">
      <h1>The following microformats were found:</h1>
    </div>
    <ul id="hcards">

    </ul>
    <ul id="hcalendars">

    </ul>
    <ul id="hreviews">
    
    </ul>
  </div>
</body>
</html>
